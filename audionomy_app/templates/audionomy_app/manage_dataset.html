{% extends 'audionomy_app/base.html' %}
{% block title %}Manage {{ dataset.name }} - Audionomy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>{{ dataset.name }}</h2>
  <div>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEntryModal">
      <i class="fas fa-plus"></i> Add Entry
    </button>
    <a href="{% url 'export_dataset_csv' dataset.id %}" class="btn btn-primary">
      <i class="fas fa-file-export"></i> Export CSV
    </a>
    <a href="{% url 'export_dataset_json' dataset.id %}" class="btn btn-primary">
      <i class="fas fa-file-export"></i> Export JSON
    </a>
    <a href="{% url 'export_dataset_parquet' dataset.id %}" class="btn btn-primary">
      <i class="fas fa-file-export"></i> Export Parquet
    </a>
    <a href="{% url 'export_audio_zip' dataset.id %}" class="btn btn-primary">
      <i class="fas fa-file-archive"></i> Export ZIP
    </a>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-dark table-hover">
    <thead>
      <tr>
        <th scope="col"><input type="checkbox" id="selectAll"></th>
        <th scope="col">Title</th>
        <th scope="col">Style Prompt</th>
        <th scope="col">Model Used</th>
        <th scope="col">Duration (s)</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in entries %}
      <tr>
        <td><input type="checkbox" class="entryCheckbox" value="{{ entry.id }}"></td>
        <td>{{ entry.title }}</td>
        <td>{{ entry.style_prompt|default:"N/A" }}</td>
        <td>{{ entry.model_used|default:"N/A" }}</td>
        <td>{{ entry.audio1_duration|default:"N/A" }}</td>
        <td>
          <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editEntryModal{{ entry.id }}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteEntryModal{{ entry.id }}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      </tr>

      <!-- Edit Entry Modal -->
      <div class="modal fade" id="editEntryModal{{ entry.id }}" tabindex="-1" aria-labelledby="editEntryModalLabel{{ entry.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editEntryModalLabel{{ entry.id }}">Edit Entry: {{ entry.title }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              {% include 'audionomy_app/edit_entry.html' with entry=entry %}
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Entry Modal -->
      <div class="modal fade" id="deleteEntryModal{{ entry.id }}" tabindex="-1" aria-labelledby="deleteEntryModalLabel{{ entry.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger">
              <h5 class="modal-title" id="deleteEntryModalLabel{{ entry.id }}">Confirm Delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete entry "<strong>{{ entry.title }}</strong>"? This action cannot be undone.
            </div>
            <div class="modal-footer">
              <form method="post" action="{% url 'delete_entry' entry.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Delete Permanently</button>
              </form>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </div>
      </div>

      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted">No entries available.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Add Entry Modal -->
<div class="modal fade" id="addEntryModal" tabindex="-1" aria-labelledby="addEntryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addEntryModalLabel">Add New Entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% include 'audionomy_app/add_entry.html' with dataset=dataset %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // "Select All" checkbox functionality.
  document.getElementById("selectAll").addEventListener("change", function(e) {
    document.querySelectorAll(".entryCheckbox").forEach(function(checkbox) {
      checkbox.checked = e.target.checked;
    });
  });
});
</script>

<!-- Export Loading Spinner (hidden by default) -->
<div id="exportSpinner" class="d-none position-fixed top-50 start-50 translate-middle">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<script>
function showExportSpinner() {
  document.getElementById("exportSpinner").classList.remove("d-none");
}
function hideExportSpinner() {
  document.getElementById("exportSpinner").classList.add("d-none");
}

// Example: Attach to export links if using AJAX (otherwise, this can be integrated in your AJAX call).
document.querySelectorAll('.btn-primary[href*="export"]').forEach(link => {
  link.addEventListener('click', function(e) {
    showExportSpinner();
    // You might call your AJAX export function here.
    // For demonstration, hide the spinner after 2 seconds.
    setTimeout(hideExportSpinner, 2000);
  });
});
</script>

{% endblock %}
