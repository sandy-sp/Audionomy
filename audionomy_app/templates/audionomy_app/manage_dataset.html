{% extends 'audionomy_app/base.html' %}
{% block title %}Manage {{ dataset.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Dataset Title & Actions -->
    <div class="d-flex justify-content-between align-items-center">
        <h2>{{ dataset.name }}</h2>
        <div>
            <a href="{% url 'add_entry' dataset.id %}" class="btn btn-success">+ Add Entry</a>
            <button class="btn btn-danger" id="deleteSelected">üóë Delete Selected</button>
            <a href="{% url 'export_dataset' dataset.id %}" class="btn btn-primary">‚¨á Export CSV</a>
        </div>
    </div>

    <p class="text-muted">Created on {{ dataset.created_at|date:"M d, Y" }}</p>
    <hr>

    <!-- Entries Table -->
    <h4 class="mt-3">Dataset Entries</h4>
    <div class="table-responsive">
        <table class="table table-hover table-bordered" id="entriesTable">
            <thead class="table-dark">
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Title</th>
                    <th>Style Prompt</th>
                    <th>Exclude Style</th>
                    <th>Model Used</th>
                    <th>Duration (s)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td><input type="checkbox" class="entryCheckbox" value="{{ entry.id }}"></td>
                    <td>{{ entry.title }}</td>
                    <td>{{ entry.style_prompt|default:"N/A" }}</td>
                    <td>{{ entry.exclude_style_prompt|default:"N/A" }}</td>
                    <td>{{ entry.model_used|default:"N/A" }}</td>
                    <td>{{ entry.audio1_duration|default:"N/A" }}</td>
                    <td>
                        <a href="{% url 'edit_entry' entry.id %}" class="btn btn-warning btn-sm">‚úè Edit</a>
                        <a href="{% url 'delete_entry' entry.id %}" class="btn btn-danger btn-sm">üóë Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center text-muted">No entries available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Bootstrap Modal for Bulk Delete Confirmation -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Bulk Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger">Are you sure you want to delete the selected entries? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap & DataTables JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<!-- JavaScript Enhancements -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize DataTables for sorting and searching
    let table = new DataTable("#entriesTable", {
        paging: true,
        searching: true,
        ordering: true,
        responsive: true
    });

    // Select/Deselect All Checkboxes
    document.getElementById("selectAll").addEventListener("change", function() {
        let checkboxes = document.querySelectorAll(".entryCheckbox");
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    });

    // Show Delete Confirmation Modal
    document.getElementById("deleteSelected").addEventListener("click", function() {
        let selected = document.querySelectorAll(".entryCheckbox:checked");
        if (selected.length > 0) {
            let modal = new bootstrap.Modal(document.getElementById("deleteModal"));
            modal.show();
        } else {
            alert("No entries selected!");
        }
    });

    // Handle Bulk Delete (AJAX Placeholder - You need to implement backend)
    document.getElementById("confirmDelete").addEventListener("click", function() {
        let selected = Array.from(document.querySelectorAll(".entryCheckbox:checked")).map(cb => cb.value);
        console.log("Deleting entries:", selected);
        // TODO: Implement AJAX request to delete selected entries
        window.location.reload();  // Reload page after deletion
    });
});
</script>
{% endblock %}
